controller_server:
  ros__parameters:
    use_sim_time: false
    controller_frequency: 20.0

    min_x_velocity_threshold: 0.01
    min_theta_velocity_threshold: 0.02
    failure_tolerance: 0.5

    controller_plugins: ["FollowPath"]

    progress_checker_plugin: "progress_checker"
    goal_checker_plugins: ["goal_checker"]

    progress_checker:
      plugin: "nav2_controller::SimpleProgressChecker"
      required_movement_radius: 0.2
      movement_time_allowance: 10.0

    goal_checker:
      plugin: "nav2_controller::SimpleGoalChecker"
      xy_goal_tolerance: 0.2
      yaw_goal_tolerance: 0.2
      stateful: true

    FollowPath:
      plugin: "dwb_core::DWBLocalPlanner"

      # --- 仿真速度（稳定第一） ---
      min_vel_x: 0.0
      max_vel_x: 0.25
      max_vel_theta: 0.8

      acc_lim_x: 0.6
      acc_lim_theta: 1.2
      decel_lim_x: -0.6
      decel_lim_theta: -1.2

      # 采样增强一点，减少"全都不可行"
      vx_samples: 20
      vtheta_samples: 40
      sim_time: 2.0

      linear_granularity: 0.05
      angular_granularity: 0.05

      transform_tolerance: 0.3
      trans_stopped_velocity: 0.01
      theta_stopped_velocity: 0.01

      critics:
        - RotateToGoal
        - Oscillation
        - PathAlign
        - PathDist
        - GoalDist

    RotateToGoal:
      scale: 20.0
      slowing_factor: 5.0

    PathAlign:
      scale: 16.0
      forward_point_distance: 0.3

    PathDist:
      scale: 16.0

    GoalDist:
      scale: 8.0


planner_server:
  ros__parameters:
    use_sim_time: false
    planner_plugins: ["GridBased"]

    GridBased:
      plugin: "nav2_navfn_planner/NavfnPlanner"
      tolerance: 0.5
      use_astar: false
      allow_unknown: true


bt_navigator:
  ros__parameters:
    use_sim_time: false
    global_frame: map
    robot_base_frame: base_link
    odom_topic: odom
    default_bt_xml_filename: "navigate_w_replanning_and_recovery.xml"


behavior_server:
  ros__parameters:
    use_sim_time: false


waypoint_follower:
  ros__parameters:
    use_sim_time: false
    stop_on_failure: false


velocity_smoother:
  ros__parameters:
    use_sim_time: false


# -------------------------
# Costmaps (仿真无激光版本)
# -------------------------
local_costmap:
  local_costmap:
    ros__parameters:
      use_sim_time: false

      global_frame: odom
      robot_base_frame: base_link
      rolling_window: true
      width: 3
      height: 3
      resolution: 0.05

      update_frequency: 10.0
      publish_frequency: 5.0

      robot_radius: 0.15

      # ✅ 只用静态地图层 + 膨胀层（不需要 /scan）
      plugins: ["static_layer", "inflation_layer"]

      static_layer:
        plugin: "nav2_costmap_2d::StaticLayer"
        # ✅ 关键：保证 map_server 的 latched 地图能立刻被订到
        map_subscribe_transient_local: True

      inflation_layer:
        plugin: "nav2_costmap_2d::InflationLayer"
        # ✅ 仿真先小一点，避免通道被胀没导致 planner 失败
        inflation_radius: 0.10
        cost_scaling_factor: 5.0


global_costmap:
  global_costmap:
    ros__parameters:
      use_sim_time: false

      global_frame: map
      robot_base_frame: base_link
      resolution: 0.05

      update_frequency: 2.0
      publish_frequency: 1.0

      robot_radius: 0.15

      plugins: ["static_layer", "inflation_layer"]

      static_layer:
        plugin: "nav2_costmap_2d::StaticLayer"
        map_subscribe_transient_local: True

      inflation_layer:
        plugin: "nav2_costmap_2d::InflationLayer"
        inflation_radius: 0.10
        cost_scaling_factor: 5.0
